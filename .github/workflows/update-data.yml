name: Update Data

on:
  schedule:
    - cron: "0 9,17 * * *"
  push:
    branches: ["main"]
    paths:
      - '.github/workflows/update.cs'
      - '.github/workflows/update-data.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
      with:
        fetch-depth: 2
    - uses: actions/setup-node@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x
    - name: Install playwright browsers
      run: npx playwright@1.50.0 install --only-shell --with-deps
    - name: Restore dependencies
      run: dotnet restore .github/workflows/update.cs
    - name: Run
      run: dotnet run --no-restore .github/workflows/update.cs
    - name: Check file changed
      shell: pwsh
      id: check_file_changed
      run: |
        $diff = git status --porcelain
        Write-Output "diff=$diff"
        $diff = $diff | Where-Object { $_ -match '^(?:\?\?|[ MADRCU?!]{2}) (events-job.json|_data/events/|event-imgs/)' }
        $hasDiff = $diff.Length -gt 0
        Write-Output "hasDiff=$hasDiff"
        "hasDiff=$hasDiff" >> $env:GITHUB_OUTPUT
    - name: Commit updates
      if: steps.check_file_changed.outputs.hasDiff == 'True'
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add --all
        if ! git commit -m "Update data"; then
          echo "git commit failed. Check the repository state." >&2
          git status >&2
          exit 1
        fi
        if ! git push; then
          echo "git push failed. Changes were not pushed to the remote." >&2
          exit 1
        fi
    - uses: actions/upload-artifact@v4
      name: Upload screenshots on failure
      if: failure()
      with:
        path: screen*.jpg
