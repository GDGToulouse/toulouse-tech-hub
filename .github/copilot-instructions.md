# Toulouse Tech Hub - Copilot Instructions

## Project Overview

This is a **Jekyll-based static site** that aggregates tech events and communities in Toulouse, France. The site automatically scrapes Meetup pages and community websites to maintain a unified calendar.

**Live site:** https://toulouse-tech-hub.fr

## Architecture

### Static Site Generation
- **Jekyll** builds the site using Liquid templates
- **GitHub Actions** deploys automatically on push to `main` and daily at 4am UTC (via cron)
- No build tools, test runners, or package managers - pure Jekyll

### Data Model
All data lives as Jekyll collections (markdown files with YAML front matter):

- **`_groups/` collection** – Community definitions  
  - One `.md` file per community (e.g., `gdg.md`, `jug.md`, `python.md`)
  - Front matter fields: `id`, `name`, `url`, `description` (HTML), `social[]` array
  - Images in `groups-imgs/` named `{group-id}.{ext}` (e.g., `jug.jpg`)

- **`_confs/` collection** – Annual conferences
  - One `.md` file per conference (e.g., `cloud-toulouse.md`, `pgday.md`)
  - Front matter fields: `id`, `name`, `date` (optional ISO format), `url`, `image`, `social[]` array
  - Images in `confs-imgs/` named `{conf-id}.{ext}` (e.g., `devfest.jpg`)

- **`_events/` collection** – Events (auto-generated from scraper)
  - One `.md` file per event, named by date and source (e.g., `2025-03-04-agile-meetup-305839478.md`)
  - Front matter fields: `id`, `title`, `community`, `datePublished`, `dateIso`, `dateFr`, `timeFr`, `link`, `img`, `localImg`, `place` (optional), `placeAddr` (optional), `description` (optional), `dateIsoEnd` (optional)
  - Images in `event-imgs/` referenced by `localImg` field

- **Legacy reference** – `events-job.json` (repo root) - Source-of-truth list generated by the scraper job; guides updates to `_events/` collection

### Output Formats
The site generates multiple consumable formats from the same event data:

1. **HTML** (`index.md` → `/`) - Main calendar view with Bootstrap cards
2. **iCal** (`events.ics`) - Calendar subscription format
3. **Atom/RSS** (`events.atom.xml`) - Feed format
4. **JSON** (`events.json`) - API format with event details
5. **Organizer tool** (`orgas.html`) - Interactive event selector with PNG export using html2canvas

All formats filter future events only using Liquid's date comparison: `{%- if event_time < now_time -%}{%- continue -%}{%- endif -%}`

### Layout Structure
- **`_layouts/default.html`** - Single layout with Bootstrap 5.0.2 + Bootstrap Icons
- **`index.md`** - Main page with three sections: Agenda (events), Conférences (annual conferences), Communautés (groups)

## Key Conventions

### Date Handling
- `dateIso`: ISO 8601 format (`YYYY-MM-DD HH:MM`) used for sorting and time math
- `dateFr`: French display format (`"jeudi 12 février"`)
- `timeFr`: Time display (`"18:45"`)
- Jekyll's `site.time` is compared as Unix timestamps: `| date: "%s" | plus: 0`

### Scraper Control
- To suppress a scraper-generated event, add a `.skip` file next to the markdown file (example: `_events/2025-03-04-agile-meetup-305839478.md.skip`).

### Event IDs
- Meetup events use `meetup-<numericId>` (example: `meetup-305479083`).
- Toulouse Game Dev events use `tgd-YYYY-MM-DD` based on the event date.

### Image Management
- Event images are stored in `event-imgs/` with filename matching the event ID
- Conference images are in `confs-imgs/`
- Images should be WebP format when possible
- Cards use `aspect-ratio: 16/9` CSS for consistent display

### File Encoding
- Files should be UTF-8; see `.editorconfig`

### Event Lifecycle
1. **Automated**: Update Data workflow runs at 9:00 and 17:00 UTC, executes `.github/workflows/update.cs`, updates `events-job.json`, downloads images into `event-imgs/`, and generates `_events/*.md`
2. **Manual**: Create markdown file in `_events/` following the convention, submit PR
3. **Build**: Jekyll generates all output formats on every build
4. **Display**: Only future events appear (past events are filtered by Liquid templates)

### Data Update Job
- Script: `.github/workflows/update.cs`
- Workflow: `.github/workflows/update-data.yml`
- Schedule: runs at 9:00 and 17:00 UTC, plus manual dispatch
- The script resolves the repo root by walking up to find `events-job.json`

### Adding a New Event Manually
Create a markdown file in `_events/` following the naming convention `YYYY-MM-DD-{community-slug}-{event-id}.md`:
```yaml
---
id: 'unique-id'
title: 'Event Title'
community: 'Community Name'
dateIso: 'YYYY-MM-DD HH:MM'
datePublished: 'YYYY-MM-DD HH:MM'
dateFr: 'jour DD mois'
timeFr: 'HH:MM'
place: "Venue Name"
placeAddr: "Address"
link: https://example.com
img: https://example.com/image.jpg
localImg: event-imgs/unique-id.webp
description: |
  HTML description (can be multi-line)
---
```

### Adding a New Community
Create a markdown file in `_groups/` named `{community-slug}.md`:
```yaml
---
id: slug
name: Full Name
url: https://website.com
description: |
  <p>HTML description</p>
social:
  - icon: bi-globe
    url: https://example.com
    title: Website
  - icon: bi-twitter-x
    url: https://x.com/handle
    title: Page X / Twitter
---
```

### Adding a New Conference
Create a markdown file in `_confs/` named `{conference-slug}.md`:
```yaml
---
id: slug
name: Conference Name
date: YYYY-MM-DD
url: https://example.com
image: confs-imgs/slug.jpg
social:
  - icon: bi-globe
    url: https://example.com
    title: Official Site
---
```

## Working with Jekyll Locally

No build commands - Jekyll runs via GitHub Actions only. To test locally:

### Windows Developers (Recommended)
- Use Ubuntu via WSL for the development environment.
- Install Jekyll inside the Ubuntu (WSL) distro.
- Use VS Code with the WSL extension to work in the Linux filesystem.

### WSL Prerequisites (Ubuntu)
```bash
sudo apt update
sudo apt install -y ruby-full build-essential zlib1g-dev

gem install jekyll bundler

ruby -v
jekyll -v
```

### Local Testing (All Platforms)
```bash
# Install Jekyll (if needed)
gem install jekyll bundler

# Serve locally
jekyll serve

# View at http://localhost:4000
```

## Visual Workflow (playwright-cli)

### Purpose
Use `playwright-cli` to automate browser navigation and capture snapshots/screenshots while iterating on visual changes.

### Prerequisites (WSL)
- Node.js with `npx` available.
- `playwright-cli` available (install globally or use `npx playwright-cli`).
- Jekyll running locally (`jekyll serve`).

### Installation rapide

```bash
npm install -g playwright-cli
playwright-cli open --browser=chromium https://example.com
```

Alternative sans installation globale:

```bash
npx playwright-cli open --browser=chromium https://example.com
```

### Interactive Workflow

1. **Start the site**: `jekyll serve` in the terminal (it auto-regenerates on file changes).
2. **Open a browser session**:
  - `playwright-cli open --browser=chromium http://localhost:4000`
3. **Navigate and capture**:
  - `playwright-cli snapshot`
  - `playwright-cli screenshot --filename=home.png`
4. **Verify changes**: Screenshot file appears in the working directory.

### Output & Artifacts
- Screenshots are saved to the working directory (e.g., `home.png`).
- Snapshot files are saved in `.playwright-cli/` by default.
- Keep these out of git via `.gitignore` (already configured).

### Troubleshooting
- **Browser not installed**: Run `playwright-cli open --browser=chromium` once or use `npx playwright-cli`.
- **Command not found**: Install with `npm install -g playwright-cli` or use `npx playwright-cli`.
- **Screenshots not appearing**: Check the working directory and `.playwright-cli/` output.

## Deployment

Automatic via `.github/workflows/jekyll-gh-pages.yml`:
- Triggers on push to `main`
- Runs daily at 4am UTC to refresh event list
- Builds with `actions/jekyll-build-pages@v1`
- Deploys to GitHub Pages

## Special Features

### Organizer Tool (`orgas.html`)
- Interactive event card selector
- Removes unwanted events with × button
- Captures visible cards as PNG using html2canvas library
- Designed for meetup organizers to create promotional slides
## Development Notes & Lessons Learned

### Liquid Template Gotchas
When working with Liquid filters in loops and ranges:

1. **Filters in range loops don't evaluate inline**
   - ❌ `{% for i in (0..first_day | minus: 1) %}` - the filter isn't evaluated before creating the range
   - ✅ `{% assign empty_cells = first_day | minus: 1 %}` then `{% for i in (0..empty_cells) %}`
   - This affects loops spawning empty calendar cells and similar constructs

2. **Array access with filters requires variable assignment**
   - ❌ `{{ event_counts[i | minus: 1] }}` - returns nil, filter not evaluated in bracket notation
   - ✅ `{% assign idx = i | minus: 1 %}` then `{{ event_counts[idx] }}`
   - Always assign computed indices to a variable before array access

**Impact**: Calendar and event loops must pre-compute loop variables to avoid silent failures

### Data-Driven Architecture Pattern
Recent refactors established this pattern for dynamic content:

- **`_data/confs.yml`** - Conferences now use YAML instead of hardcoded HTML cards
- **`_includes/conferences.html`** - Renders conferences from YAML data
- **`_includes/calendar.html`** - Generates month grids dynamically with event counting
- Same pattern should be applied to other static/semi-static content (groups cards already do this)

**Benefits**: Easy to add/update content without touching templates, single source of truth per component

### Bootstrap Icons in YAML
Simplified social links structure:

- ❌ Old: `name: "globe"` → if/elif in template to map names to `bi-globe` classes
- ✅ New: `icon: "bi-globe"` → directly render `<i class="bi {{ social.icon }}"></i>`

This reduces template logic and makes icon codes visible in YAML data

### Calendar Implementation Notes
- Week starts Monday (France convention) - Sunday is column 7 (Dim)
- Event counting filters future events using `site.time` as Unix timestamp
- Badge colors: green (1), orange (2-3), red (4-6), dark red (7+)
- Dates use `{{ conf.date | date: "%d %B %Y" }}` format for display
- Date-range support: if `end` field exists, display as "01 Jan - 02 Jan"

## Git Workflow

### Development Process
1. **Make changes**: Edit files, create new files, modify configuration
2. **Build & validate**: Run `jekyll build` to check for errors, verify output
3. **Review**: Test visually with browser or MCP if needed
4. **Stop and wait**: Do NOT commit automatically - wait for user validation
5. **User approval**: User reviews changes and indicates approval
6. **Commit only then**: Run `git add`, `git commit`, `git push` only after explicit approval

### Key Rules
- ⛔ **Never auto-commit** - Always wait for explicit user approval
- ⛔ **Never git push** until user validates the changes
- ✅ **Do test locally** - Run `jekyll build` to verify no errors before stopping
- ✅ **Do show the work** - Report what was changed and where
- ✅ **Do suggest commit message** - Describe changes in a clear message when ready to commit

### Branch Strategy
- Current development branch: `copilot` (for experimental features)
- Target for merging: `main` (production)
- Always push to the feature/current branch, never directly to `main`
