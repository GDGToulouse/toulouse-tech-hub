# Toulouse Tech Hub - Copilot Instructions

## Project Overview

This is a **Jekyll-based static site** that aggregates tech events and communities in Toulouse, France. The site automatically scrapes Meetup pages and community websites to maintain a unified calendar.

**Live site:** https://toulouse-tech-hub.fr

## Architecture

### Static Site Generation
- **Jekyll** builds the site using Liquid templates
- **GitHub Actions** deploys automatically on push to `main` and daily at 4am UTC (via cron)
- No build tools, test runners, or package managers - pure Jekyll

### Data Model
All data lives in `_data/` as YAML files:

- **`_data/events/*.yml`** - Individual event files (one per event)
  - Naming convention: `YYYY-MM-DD-{community}-{identifier}.yml`
  - Required fields: `id`, `title`, `community`, `datePublished`, `dateIso`, `dateFr`, `timeFr`, `link`, `img`, `localImg`
  - Optional fields: `place`, `placeAddr`, `description`, `dateIsoEnd`
  
- **`_data/groups.yml`** - Community definitions
  - Each entry can have: `id`, `name`, `url`, `registration`, `description`, `social[]`

- **`_data/confs.yml`** - Major annual conferences (currently unused, hardcoded in index.md)
- **`events-job.json`** (repo root) - Source-of-truth list generated by the scraper job; used to detect updates and to regenerate `_data/events/*.yml` and `event-imgs/`.

### Output Formats
The site generates multiple consumable formats from the same event data:

1. **HTML** (`index.md` → `/`) - Main calendar view with Bootstrap cards
2. **iCal** (`events.ics`) - Calendar subscription format
3. **Atom/RSS** (`events.atom.xml`) - Feed format
4. **JSON** (`events.json`) - API format with event details
5. **Organizer tool** (`orgas.html`) - Interactive event selector with PNG export using html2canvas

All formats filter future events only using Liquid's date comparison: `{%- if event_time < now_time -%}{%- continue -%}{%- endif -%}`

### Layout Structure
- **`_layouts/default.html`** - Single layout with Bootstrap 5.0.2 + Bootstrap Icons
- **`index.md`** - Main page with three sections: Agenda (events), Conférences (annual conferences), Communautés (groups)

## Key Conventions

### Date Handling
- `dateIso`: ISO 8601 format (`YYYY-MM-DD HH:MM`) used for sorting and time math
- `dateFr`: French display format (`"jeudi 12 février"`)
- `timeFr`: Time display (`"18:45"`)
- Jekyll's `site.time` is compared as Unix timestamps: `| date: "%s" | plus: 0`

### Scraper Control
- To suppress a scraper-generated event, add a `.skip` file next to the YAML file (example: `_data/events/2025-03-04-agile-meetup-305839478.yml.skip`).

### Event IDs
- Meetup events use `meetup-<numericId>` (example: `meetup-305479083`).
- Toulouse Game Dev events use `tgd-YYYY-MM-DD` based on the event date.

### Image Management
- Event images are stored in `event-imgs/` with filename matching the event ID
- Conference images are in `confs-imgs/`
- Images should be WebP format when possible
- Cards use `aspect-ratio: 16/9` CSS for consistent display

### Event Lifecycle
1. **Automated**: Scraper job (`toulouse-tech-hub-job`) runs every 4 hours via workflow, scrapes Meetup/community sites, updates `events-job.json`, downloads images into `event-imgs/`, and generates `_data/events/*.yml`
2. **Manual**: Create YAML file following the convention, submit PR
3. **Build**: Jekyll generates all output formats on every build
4. **Display**: Only future events appear (past events are filtered by Liquid templates)

### Adding a New Event Manually
Create `_data/events/YYYY-MM-DD-{community}-{title}.yml`:
```yaml
id: 'unique-id'
title: 'Event Title'
community: 'Community Name'
dateIso: 'YYYY-MM-DD HH:MM'
dateFr: 'jour DD mois'
timeFr: 'HH:MM'
place: "Venue Name"
placeAddr: "Address"
link: https://example.com
img: https://example.com/image.jpg
localImg: event-imgs/unique-id.webp
description: >
  HTML description (can be multi-line)
```

### Adding a New Community
Add to `_data/groups.yml`:
```yaml
- id: slug
  name: Full Name
  url: https://website.com
  description: |
    <p>HTML description</p>
  social:
  - name: x
    url: https://x.com/handle
```

## Working with Jekyll Locally

No build commands - Jekyll runs via GitHub Actions only. To test locally:

### Windows Developers (Recommended)
- Use Ubuntu via WSL for the development environment.
- Install Jekyll inside the Ubuntu (WSL) distro.
- Use VS Code with the WSL extension to work in the Linux filesystem.

### WSL Prerequisites (Ubuntu)
```bash
sudo apt update
sudo apt install -y ruby-full build-essential zlib1g-dev

gem install jekyll bundler

ruby -v
jekyll -v
```

### Local Testing (All Platforms)
```bash
# Install Jekyll (if needed)
gem install jekyll bundler

# Serve locally
jekyll serve

# View at http://localhost:4000
```

## MCP Visual Workflow (Playwright)

### Purpose
Use a local MCP server to automate browser navigation and capture screenshots while iterating on visual changes.

### Prerequisites (WSL)
- Node.js with `npx` available.
- Jekyll running locally (`jekyll serve`).

### MCP Server Choice
- **Playwright MCP** (local-only) for browser automation + screenshots.

### VS Code Setup

#### Step 1: Add MCP Server to VS Code Settings
1. Open VS Code user settings: `Ctrl+Shift+P` → "Preferences: Open User Settings (JSON)"
2. Add the server config under `"servers"`:
```json
{
  "playwright": {
    "type": "stdio",
    "command": "npx",
    "args": [
      "@playwright/mcp@latest",
      "--browser", "chromium",
      "--headless",
      "--vision"
    ]
  }
}
```
3. Save and restart Copilot or VS Code.

#### Step 2: Install Browser Binaries
When you first run a Playwright MCP tool, Chromium may not be installed. Call:
- Open Copilot Chat and use: `@playwright Installe le navigateur`
- Or trigger any MCP browser action, it will prompt you to install.
- This runs `browser_install` once to download Chromium binaries.

### Interactive Workflow

1. **Start the site**: `jekyll serve` in the terminal (it auto-regenerates on file changes).
2. **Open Copilot Chat**: Ensure Playwright MCP is connected (check MCP status in Chat panel).
3. **Navigate and capture**:
   - `browser_navigate` to `http://localhost:4000`
   - `browser_snapshot` to get an accessibility snapshot (human-readable structure)
   - `browser_take_screenshot` with `filename: "home.png"` to save a visual screenshot
4. **Verify changes**: Screenshot file appears in the working directory.

### Output & Artifacts
- Screenshots are saved to the working directory (e.g., `home.png`).
- If using `--output-dir mcp-output`, files go to `mcp-output/`.
- Keep these out of git via `.gitignore` (already configured).

### Troubleshooting
- **Browser not installed**: Run `@playwright Installe le navigateur` in Copilot Chat.
- **MCP server won't connect**: Restart Copilot Chat or VS Code.
- **Screenshots not appearing**: Check the output directory path in settings.

## Deployment

Automatic via `.github/workflows/jekyll-gh-pages.yml`:
- Triggers on push to `main`
- Runs daily at 4am UTC to refresh event list
- Builds with `actions/jekyll-build-pages@v1`
- Deploys to GitHub Pages

## Special Features

### Organizer Tool (`orgas.html`)
- Interactive event card selector
- Removes unwanted events with × button
- Captures visible cards as PNG using html2canvas library
- Designed for meetup organizers to create promotional slides
## Development Notes & Lessons Learned

### Liquid Template Gotchas
When working with Liquid filters in loops and ranges:

1. **Filters in range loops don't evaluate inline**
   - ❌ `{% for i in (0..first_day | minus: 1) %}` - the filter isn't evaluated before creating the range
   - ✅ `{% assign empty_cells = first_day | minus: 1 %}` then `{% for i in (0..empty_cells) %}`
   - This affects loops spawning empty calendar cells and similar constructs

2. **Array access with filters requires variable assignment**
   - ❌ `{{ event_counts[i | minus: 1] }}` - returns nil, filter not evaluated in bracket notation
   - ✅ `{% assign idx = i | minus: 1 %}` then `{{ event_counts[idx] }}`
   - Always assign computed indices to a variable before array access

**Impact**: Calendar and event loops must pre-compute loop variables to avoid silent failures

### Data-Driven Architecture Pattern
Recent refactors established this pattern for dynamic content:

- **`_data/confs.yml`** - Conferences now use YAML instead of hardcoded HTML cards
- **`_includes/conferences.html`** - Renders conferences from YAML data
- **`_includes/calendar.html`** - Generates month grids dynamically with event counting
- Same pattern should be applied to other static/semi-static content (groups cards already do this)

**Benefits**: Easy to add/update content without touching templates, single source of truth per component

### Bootstrap Icons in YAML
Simplified social links structure:

- ❌ Old: `name: "globe"` → if/elif in template to map names to `bi-globe` classes
- ✅ New: `icon: "bi-globe"` → directly render `<i class="bi {{ social.icon }}"></i>`

This reduces template logic and makes icon codes visible in YAML data

### Calendar Implementation Notes
- Week starts Monday (France convention) - Sunday is column 7 (Dim)
- Event counting filters future events using `site.time` as Unix timestamp
- Badge colors: green (1), orange (2-3), red (4-6), dark red (7+)
- Dates use `{{ conf.date | date: "%d %B %Y" }}` format for display
- Date-range support: if `end` field exists, display as "01 Jan - 02 Jan"

## Git Workflow

### Development Process
1. **Make changes**: Edit files, create new files, modify configuration
2. **Build & validate**: Run `jekyll build` to check for errors, verify output
3. **Review**: Test visually with browser or MCP if needed
4. **Stop and wait**: Do NOT commit automatically - wait for user validation
5. **User approval**: User reviews changes and indicates approval
6. **Commit only then**: Run `git add`, `git commit`, `git push` only after explicit approval

### Key Rules
- ⛔ **Never auto-commit** - Always wait for explicit user approval
- ⛔ **Never git push** until user validates the changes
- ✅ **Do test locally** - Run `jekyll build` to verify no errors before stopping
- ✅ **Do show the work** - Report what was changed and where
- ✅ **Do suggest commit message** - Describe changes in a clear message when ready to commit

### Branch Strategy
- Current development branch: `copilot` (for experimental features)
- Target for merging: `main` (production)
- Always push to the feature/current branch, never directly to `main`
